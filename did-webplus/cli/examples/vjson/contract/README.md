# VJSON Generation Example

This example demonstrates the use of VJSON to create schemas representing the various parts of a contract between two parties,
and then creates an contract between Alice and Bob using those schemas.

Note that this file was generated by the `run.sh` script in this directory, so this file should not be modified directly.

## Schemas

### Schema "Contract" Source

This is what the schema author creates to define the structure of a "Contract".
The VJSON fields will be computed and auto-populated.

`Contract.schema-source.json`:
```json
{
  "$id": "vjson:///",
  "type": "object",
  "title": "Contract",
  "properties": {
    "$schema": {
      "type": "string",
      "description": "The schema that this JSON must adhere to."
    },
    "body": {
      "type": "string",
      "description": "The body of the contract."
    },
    "contractees": {
      "type": "object",
      "description": "Maps the public keys of the contractees to their names.",
      "additionalProperties": {
        "type": "string"
      }
    },
    "selfHash": {
      "type": "string",
      "description": "Uniquely identifies this particular Contract."
    },
    "title": {
      "type": "string",
      "description": "Concise description of the contract."
    }
  },
  "required": [
    "$schema",
    "body",
    "contractees",
    "selfHash",
    "title"
  ],
  "additionalProperties": false,
  "vjsonProperties": {
    "directDependencies": [
      "$.$schema"
    ],
    "mustBeSigned": false,
    "selfHashPaths": [
      "$.selfHash"
    ],
    "selfHashURLPaths": []
  }
}
```

### Schema "Contract" Generated

This is the VJSON schema generated from the source schema.  It is self-verifying and its "$id" field should be
used as the "$schema" field in the contract VJSON itself.  The "$schema" field refers to the Default VJSON schema,
and is auto-populated if no "$schema" field is provided.  The command used to generate this schema is:

    did-webplus vjson self-hash < Contract.schema-source.json > Contract.schema.json

Its output is the following.  Note that the generated VJSON is also stored in the VJSON doc store so that it can
be referenced by other VJSON documents.

`Contract.schema.json`:
```json
{
  "$id": "vjson:///EarvON54-o8ZPTgaGHY6l7PtutTCl1DPD3HDG6yql9BA",
  "$schema": "vjson:///EnD4KcLMLmGSjEliVPgBdMsEC2B_brlSXPV2pu7W90Xc",
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "description": "The schema that this JSON must adhere to.",
      "type": "string"
    },
    "body": {
      "description": "The body of the contract.",
      "type": "string"
    },
    "contractees": {
      "additionalProperties": {
        "type": "string"
      },
      "description": "Maps the public keys of the contractees to their names.",
      "type": "object"
    },
    "selfHash": {
      "description": "Uniquely identifies this particular Contract.",
      "type": "string"
    },
    "title": {
      "description": "Concise description of the contract.",
      "type": "string"
    }
  },
  "required": [
    "$schema",
    "body",
    "contractees",
    "selfHash",
    "title"
  ],
  "selfHash": "EarvON54-o8ZPTgaGHY6l7PtutTCl1DPD3HDG6yql9BA",
  "title": "Contract",
  "type": "object",
  "vjsonProperties": {
    "directDependencies": [
      "$.$schema"
    ],
    "mustBeSigned": false,
    "selfHashPaths": [
      "$.selfHash"
    ],
    "selfHashURLPaths": []
  }
}
```

### Schema "SignatureOnContract" Source

This is what the schema author creates to define the structure of a "SignatureOnContract".

`SignatureOnContract.schema-source.json`:
```json
{
  "$id": "vjson:///",
  "type": "object",
  "title": "SignatureOnContract",
  "properties": {
    "$schema": {
      "type": "string",
      "description": "The schema that this JSON must adhere to."
    },
    "contract": {
      "type": "string",
      "description": "Identifies which contract is being signed."
    },
    "proofs": {
      "type": "array",
      "description": "Array of detached JSON Web Signatures (JWS) over the VJSON."
    },
    "selfHash": {
      "type": "string",
      "description": "Uniquely identifies this particular SignatureOnContract."
    },
    "signedAt": {
      "type": "string",
      "format": "date-time",
      "description": "Specifies the timestamp of this signature, in RFC 3339 format."
    }
  },
  "required": [
    "$schema",
    "contract",
    "proofs",
    "selfHash",
    "signedAt"
  ],
  "additionalProperties": false,
  "vjsonProperties": {
    "directDependencies": [
      "$.$schema",
      "$.contract"
    ],
    "mustBeSigned": true,
    "selfHashPaths": [
      "$.selfHash"
    ],
    "selfHashURLPaths": []
  }
}
```

### Schema "SignatureOnContract" Generated

This is the VJSON schema generated from the source schema.  The command used to generate this schema is:

    did-webplus vjson self-hash < SignatureOnContract.schema-source.json > SignatureOnContract.schema.json

Its output is the following.

`SignatureOnContract.schema.json`:
```json
{
  "$id": "vjson:///EF97gBgXn6BiaX9wsVSq_gdtFCfnimSwoAd1oGya8eR8",
  "$schema": "vjson:///EnD4KcLMLmGSjEliVPgBdMsEC2B_brlSXPV2pu7W90Xc",
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "description": "The schema that this JSON must adhere to.",
      "type": "string"
    },
    "contract": {
      "description": "Identifies which contract is being signed.",
      "type": "string"
    },
    "proofs": {
      "description": "Array of detached JSON Web Signatures (JWS) over the VJSON.",
      "type": "array"
    },
    "selfHash": {
      "description": "Uniquely identifies this particular SignatureOnContract.",
      "type": "string"
    },
    "signedAt": {
      "description": "Specifies the timestamp of this signature, in RFC 3339 format.",
      "format": "date-time",
      "type": "string"
    }
  },
  "required": [
    "$schema",
    "contract",
    "proofs",
    "selfHash",
    "signedAt"
  ],
  "selfHash": "EF97gBgXn6BiaX9wsVSq_gdtFCfnimSwoAd1oGya8eR8",
  "title": "SignatureOnContract",
  "type": "object",
  "vjsonProperties": {
    "directDependencies": [
      "$.$schema",
      "$.contract"
    ],
    "mustBeSigned": true,
    "selfHashPaths": [
      "$.selfHash"
    ],
    "selfHashURLPaths": []
  }
}
```

### Schema "CompletedContract" Source

This is what the schema author creates to define the structure of a "CompletedContract".

`CompletedContract.schema-source.json`:
```json
{
  "$id": "vjson:///",
  "type": "object",
  "title": "CompletedContract",
  "properties": {
    "$schema": {
      "type": "string",
      "description": "The self-hash URL of the schema that this JSON must adhere to."
    },
    "contract": {
      "type": "string",
      "description": "Specifies the self-hash URL of the Contract that has been signed by all contractees and is the subject of notarization."
    },
    "selfHash": {
      "type": "string",
      "description": "Uniquely identifies this particular CompletedContract."
    },
    "signatures": {
      "type": "array",
      "description": "Specifies the self-hash URL for each of the SignatureOnContract-s of all contractees.",
      "items": {
        "type": "string"
      }
    }
  },
  "required": [
    "$schema",
    "contract",
    "selfHash",
    "signatures"
  ],
  "additionalProperties": false,
  "vjsonProperties": {
    "directDependencies": [
      "$.$schema",
      "$.contract",
      "$.signatures[*]"
    ],
    "mustBeSigned": false,
    "selfHashPaths": [
      "$.selfHash"
    ],
    "selfHashURLPaths": []
  }
}
```

### Schema "CompletedContract" Generated

This is the VJSON schema generated from the source schema.  The command used to generate this schema is:

    did-webplus vjson self-hash < CompletedContract.schema-source.json > CompletedContract.schema.json

Its output is the following.

`CompletedContract.schema.json`:
```json
{
  "$id": "vjson:///ENo1CWw92Q1X57uVceN3zo0F4CuYlDa-ASvgdLbdPXA8",
  "$schema": "vjson:///EnD4KcLMLmGSjEliVPgBdMsEC2B_brlSXPV2pu7W90Xc",
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "description": "The self-hash URL of the schema that this JSON must adhere to.",
      "type": "string"
    },
    "contract": {
      "description": "Specifies the self-hash URL of the Contract that has been signed by all contractees and is the subject of notarization.",
      "type": "string"
    },
    "selfHash": {
      "description": "Uniquely identifies this particular CompletedContract.",
      "type": "string"
    },
    "signatures": {
      "description": "Specifies the self-hash URL for each of the SignatureOnContract-s of all contractees.",
      "items": {
        "type": "string"
      },
      "type": "array"
    }
  },
  "required": [
    "$schema",
    "contract",
    "selfHash",
    "signatures"
  ],
  "selfHash": "ENo1CWw92Q1X57uVceN3zo0F4CuYlDa-ASvgdLbdPXA8",
  "title": "CompletedContract",
  "type": "object",
  "vjsonProperties": {
    "directDependencies": [
      "$.$schema",
      "$.contract",
      "$.signatures[*]"
    ],
    "mustBeSigned": false,
    "selfHashPaths": [
      "$.selfHash"
    ],
    "selfHashURLPaths": []
  }
}
```

## Content

### "RadDeal" Source

This is what the contract author creates to define the contract between Alice and Bob.  Note that it represents
the DIDs of Alice and Bob so that there is a basis for a cryptographic commitment in the contract itself.
This requires Alice and Bob both have known DIDs to begin with.  For the simplicity of this example, we generate
private keys for Alice and Bob and use their corresponding did:key values as their DIDs using the following commands:

    did-webplus did-key generate --key-type ed25519 --private-key-path Alice.priv.pem
    did-webplus did-key from-private --private-key-path Alice.priv.pem > Alice.didkey

    did-webplus did-key generate --key-type ed25519 --private-key-path Bob.priv.pem
    did-webplus did-key from-private --private-key-path Bob.priv.pem > Bob.didkey

`Alice.didkey`:
```
did:key:z6MkvbFGH99npW3Ezp6Z5j642rdqMinK5XdGWWL9Xq2VPfxW
```

`Bob.didkey`:
```
did:key:z6Mknax9nMJbuaWixHse5Mwyx24SdsfY399CnEXgS7juU6Lb
```

Now the contract can be drafted, capturing the DIDs of Alice and Bob.

`RadDeal.source.json`:
```json
{
  "$schema": "vjson:///EarvON54-o8ZPTgaGHY6l7PtutTCl1DPD3HDG6yql9BA",
  "title": "A rad deal",
  "body": "This grants Alice the privilege of blobbing upon payment of 5 megachips to Bob",
  "contractees": {
    "did:key:z6MkvbFGH99npW3Ezp6Z5j642rdqMinK5XdGWWL9Xq2VPfxW": "Alice",
    "did:key:z6Mknax9nMJbuaWixHse5Mwyx24SdsfY399CnEXgS7juU6Lb": "Bob"
  }
}
```

### "RadDeal" Generated

This is the VJSON contract generated from the source contract.  The command used to generate this contract is:

    did-webplus vjson self-hash < RadDeal.source.json > RadDeal.json

Its output is the following.

`RadDeal.json`:
```json
{
  "$schema": "vjson:///EarvON54-o8ZPTgaGHY6l7PtutTCl1DPD3HDG6yql9BA",
  "body": "This grants Alice the privilege of blobbing upon payment of 5 megachips to Bob",
  "contractees": {
    "did:key:z6Mknax9nMJbuaWixHse5Mwyx24SdsfY399CnEXgS7juU6Lb": "Bob",
    "did:key:z6MkvbFGH99npW3Ezp6Z5j642rdqMinK5XdGWWL9Xq2VPfxW": "Alice"
  },
  "selfHash": "E9SHLCTnyfdj4cRhZ7HBGIM7CPmSYKbS4IU4XpP_Fv6s",
  "title": "A rad deal"
}
```

### "AliceSignature" Source

This is what Alice creates to sign the contract.  It refers to the contract being signed by its VJSON URL.

`AliceSignature.source.json`:
```json
{
  "$schema": "vjson:///EF97gBgXn6BiaX9wsVSq_gdtFCfnimSwoAd1oGya8eR8",
  "contract": "vjson:///E9SHLCTnyfdj4cRhZ7HBGIM7CPmSYKbS4IU4XpP_Fv6s",
  "signedAt": "2024-11-21T07:40:28Z"
}
```

### "AliceSignature" Generated

This is the VJSON signature generated from the source signature.  The command used to generate this signature is:

    did-webplus did-key sign vjson --private-key-path Alice.priv.pem < AliceSignature.source.json > AliceSignature.json

Its output is the following.

`AliceSignature.json`:
```json
{
  "$schema": "vjson:///EF97gBgXn6BiaX9wsVSq_gdtFCfnimSwoAd1oGya8eR8",
  "contract": "vjson:///E9SHLCTnyfdj4cRhZ7HBGIM7CPmSYKbS4IU4XpP_Fv6s",
  "proofs": [
    "eyJhbGciOiJFZERTQSIsImtpZCI6ImRpZDprZXk6ejZNa3ZiRkdIOTlucFczRXpwNlo1ajY0MnJkcU1pbks1WGRHV1dMOVhxMlZQZnhXI3o2TWt2YkZHSDk5bnBXM0V6cDZaNWo2NDJyZHFNaW5LNVhkR1dXTDlYcTJWUGZ4VyJ9..WhI27N8V72fteiqgHt4LZZ3R_O1MzpdSe7Q9q3MYHYOcIMG6BieazU6b7qf03oCSgHDW80V4MCpHlLSV-c2SDQ"
  ],
  "selfHash": "Ecynes3DHw7Lg4fBjcOX0wYz49abEbZm6_c9sPWP8cLw",
  "signedAt": "2024-11-21T07:40:28Z"
}
```

### "BobSignature" Source

This is what Bob creates to sign the contract.  It refers to the contract being signed by its VJSON URL.

`BobSignature.source.json`:
```json
{
  "$schema": "vjson:///EF97gBgXn6BiaX9wsVSq_gdtFCfnimSwoAd1oGya8eR8",
  "contract": "vjson:///E9SHLCTnyfdj4cRhZ7HBGIM7CPmSYKbS4IU4XpP_Fv6s",
  "signedAt": "2024-11-21T08:22:31Z"
}
```

### "BobSignature" Generated

This is the VJSON signature generated from the source signature.  The command used to generate this signature is:

    did-webplus did-key sign vjson --private-key-path Bob.priv.pem < BobSignature.source.json > BobSignature.json

Its output is the following.

`BobSignature.json`:
```json
{
  "$schema": "vjson:///EF97gBgXn6BiaX9wsVSq_gdtFCfnimSwoAd1oGya8eR8",
  "contract": "vjson:///E9SHLCTnyfdj4cRhZ7HBGIM7CPmSYKbS4IU4XpP_Fv6s",
  "proofs": [
    "eyJhbGciOiJFZERTQSIsImtpZCI6ImRpZDprZXk6ejZNa25heDluTUpidWFXaXhIc2U1TXd5eDI0U2RzZlkzOTlDbkVYZ1M3anVVNkxiI3o2TWtuYXg5bk1KYnVhV2l4SHNlNU13eXgyNFNkc2ZZMzk5Q25FWGdTN2p1VTZMYiJ9..I57rhcxKRIchhf1jBu65piP0B9u2biMcfcRjotakNQET2jSbnzTl7eudTMlTfbSOIRMJXkiJqc6bQHpD3dMiBg"
  ],
  "selfHash": "E9PY-1WhSB-R-6iNeBYOG3doZsCgOuV387Thx600FdhU",
  "signedAt": "2024-11-21T08:22:31Z"
}
```

### "CompletedRadDeal" Source

This is what is written to complete the contract.  It refers to the contract and the signatures by their respective VJSON URLs.

`CompletedRadDeal.source.json`:
```json
{
  "$schema": "vjson:///ENo1CWw92Q1X57uVceN3zo0F4CuYlDa-ASvgdLbdPXA8",
  "contract": "vjson:///E9SHLCTnyfdj4cRhZ7HBGIM7CPmSYKbS4IU4XpP_Fv6s",
  "signatures": [
    "vjson:///Ecynes3DHw7Lg4fBjcOX0wYz49abEbZm6_c9sPWP8cLw",
    "vjson:///E9PY-1WhSB-R-6iNeBYOG3doZsCgOuV387Thx600FdhU"
  ]
}
```

### "CompletedRadDeal" Generated

This is the VJSON contract generated from the source contract.  The command used to generate this contract is:

    did-webplus vjson self-hash < CompletedRadDeal.source.json > CompletedRadDeal.json

Its output is the following.

`CompletedRadDeal.json`:
```json
{
  "$schema": "vjson:///ENo1CWw92Q1X57uVceN3zo0F4CuYlDa-ASvgdLbdPXA8",
  "contract": "vjson:///E9SHLCTnyfdj4cRhZ7HBGIM7CPmSYKbS4IU4XpP_Fv6s",
  "selfHash": "EPebLyN3F7RSqIg5TNT5StnM4mPEG1VqJmzjzFkg-HUY",
  "signatures": [
    "vjson:///Ecynes3DHw7Lg4fBjcOX0wYz49abEbZm6_c9sPWP8cLw",
    "vjson:///E9PY-1WhSB-R-6iNeBYOG3doZsCgOuV387Thx600FdhU"
  ]
}
```

## VJSON Doc Store

The result of each VJSON generation and verification is stored in the VJSON doc store, so that when a VJSON document
references another VJSON document, the referenced document can be resolved (and verified if necessary).  These documents
can be retrieved by their VJSON URLs.  For example:

    did-webplus vjson store get "vjson:///E9SHLCTnyfdj4cRhZ7HBGIM7CPmSYKbS4IU4XpP_Fv6s" | jq .

produces:

```json
{
  "$schema": "vjson:///EarvON54-o8ZPTgaGHY6l7PtutTCl1DPD3HDG6yql9BA",
  "body": "This grants Alice the privilege of blobbing upon payment of 5 megachips to Bob",
  "contractees": {
    "did:key:z6Mknax9nMJbuaWixHse5Mwyx24SdsfY399CnEXgS7juU6Lb": "Bob",
    "did:key:z6MkvbFGH99npW3Ezp6Z5j642rdqMinK5XdGWWL9Xq2VPfxW": "Alice"
  },
  "selfHash": "E9SHLCTnyfdj4cRhZ7HBGIM7CPmSYKbS4IU4XpP_Fv6s",
  "title": "A rad deal"
}
```

Note that VJSON docs are stored in JCS format (JSON Canonicalization Scheme) to ensure deterministic representation.
In particular, JCS has no newlines, so it's hard to read, thus usage of the `jq` command to pretty-print the output.

There is a "Default" schema which is used as the schema any time the "$schema" field is not provided in a VJSON document.
This schema is stored in the VJSON doc store as well, and can be retrieved by the following command:

    did-webplus vjson default-schema | jq .

produces:

```json
{
  "$id": "vjson:///EnD4KcLMLmGSjEliVPgBdMsEC2B_brlSXPV2pu7W90Xc",
  "$schema": "vjson:///EnD4KcLMLmGSjEliVPgBdMsEC2B_brlSXPV2pu7W90Xc",
  "additionalProperties": true,
  "properties": {
    "$id": {
      "description": "The VJSON URL of this schema, used to uniquely identify and resolve it.",
      "type": "string"
    },
    "selfHash": {
      "description": "Uniquely identifies this particular VJSON.",
      "type": "string"
    }
  },
  "required": [
    "$id",
    "$schema",
    "selfHash"
  ],
  "selfHash": "EnD4KcLMLmGSjEliVPgBdMsEC2B_brlSXPV2pu7W90Xc",
  "title": "Default VJSON Schema",
  "type": "object",
  "vjsonProperties": {
    "directDependencies": [
      "$.$schema"
    ],
    "mustBeSigned": false,
    "selfHashPaths": [
      "$.selfHash"
    ],
    "selfHashURLPaths": [
      "$.$id"
    ]
  }
}
```

The Default schema is special in that it is its own schema; the "$id\" field is the same as the "$schema" field.

## Verification

All VJSON documents are verified upon creation.  However, they can be reverified -- or verified by another party -- using 
the `did-webplus vjson verify` command.  For example:

    did-webplus vjson verify < RadDeal.json

will verify the RadDeal VJSON document.  The output will be the verified VJSON document:

```json
{
  "$schema": "vjson:///EarvON54-o8ZPTgaGHY6l7PtutTCl1DPD3HDG6yql9BA",
  "body": "This grants Alice the privilege of blobbing upon payment of 5 megachips to Bob",
  "contractees": {
    "did:key:z6Mknax9nMJbuaWixHse5Mwyx24SdsfY399CnEXgS7juU6Lb": "Bob",
    "did:key:z6MkvbFGH99npW3Ezp6Z5j642rdqMinK5XdGWWL9Xq2VPfxW": "Alice"
  },
  "selfHash": "E9SHLCTnyfdj4cRhZ7HBGIM7CPmSYKbS4IU4XpP_Fv6s",
  "title": "A rad deal"
}
```

